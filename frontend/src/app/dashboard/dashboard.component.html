<div class="container mt-4">
  <h2 class="mb-4">Dashboard</h2>

  @if (isManager()) {
  <button class="btn btn-primary mb-3" (click)="showCreateModal = true">
    + New trade
  </button>
  }

  <div class="card shadow-sm">
    <div class="card-body">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>Instrument</th>
            <th>Account</th>
            <th>Direction</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          @for (trade of trades; track trade.id) {
          <tr>
            <td>{{ trade.instrument.code }}</td>
            <td>{{ trade.account.name }}</td>
            <td>
              <span
                [class.badge]="true"
                [class.bg-danger]="trade.direction === 'BUY'"
                [class.bg-warning]="trade.direction === 'SELL'"
              >
                {{ trade.direction }}
              </span>
            </td>
            <td>{{ trade.quantity }}</td>
            <td>{{ trade.price | number : "1.2-2" }}</td>
            <td>
              <span
                [class.badge]="true"
                [class.bg-success]="trade.status === 'OPEN'"
                [class.bg-yellow]="trade.status === 'MATCHED'"
                [class.bg-info]="trade.status === 'EXERCISED'"
                [class.bg-secondary]="trade.status === 'CLOSED'"
              >
                {{ trade.status }}
              </span>
            </td>
            <td>
              <button
                class="btn btn-sm btn-outline-primary me-1"
                (click)="startEdit(trade)"
              >
                Edit
              </button>

              @if (isManager()) {
              <button
                class="btn btn-sm btn-outline-danger me-1"
                (click)="deleteTrade(trade.id)"
              >
                Delete
              </button>
              } @if (trade.status === 'OPEN') {
              <button
                class="btn btn-sm btn-outline-success"
                (click)="confirmMatch(trade)"
              >
                Match
              </button>
              } @if (trade.status === 'MATCHED') {
              <button
                class="btn btn-sm btn-outline-info"
                (click)="exerciseTrade(trade.id)"
              >
                Exercise
              </button>
              }
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- <div class="mt-4">
    <button class="btn btn-outline-secondary" (click)="logout()">Logout</button>
  </div> -->
</div>

@if (matchConfirmation) {
<div
  class="modal fade show d-block"
  style="background: rgba(0, 0, 0, 0.5)"
  tabindex="-1"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Match</h5>
        <button
          type="button"
          class="btn-close"
          (click)="cancelMatch()"
        ></button>
      </div>
      <div class="modal-body">
        <p>You are about to create a matching trade:</p>

        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">
              Original Trade ({{ matchConfirmation.original.direction }})
            </h6>
            <p class="card-text">
              {{ matchConfirmation.original.quantity }} x
              {{ matchConfirmation.original.instrument.code }} at
              {{ matchConfirmation.original.price | number : "1.2-2" }}
            </p>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">
              Matching Trade ({{ matchConfirmation.matching.direction }})
            </h6>
            <p class="card-text">
              {{ matchConfirmation.matching.quantity }} x
              {{ matchConfirmation.original.instrument.code }} at
              {{ matchConfirmation.matching.price | number : "1.2-2" }}
            </p>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Select Account for Matching Trade</label>
          <select
            class="form-select"
            [(ngModel)]="matchConfirmation.matching.accountId"
            name="matchingAccountId"
          >
            @for (acc of accounts; track acc.id) {
            <option [value]="acc.id">{{ acc.name }}</option>
            }
          </select>
        </div>
        <p class="mt-3">Are you sure you want to proceed?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelMatch()">
          Cancel
        </button>
        <button type="button" class="btn btn-success" (click)="executeMatch()">
          Confirm Match
        </button>
      </div>
    </div>
  </div>
</div>
} @if (showCreateModal) {
<div
  class="modal fade show d-block"
  style="background: rgba(0, 0, 0, 0.5)"
  tabindex="-1"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create trade</h5>
        <button
          type="button"
          class="btn-close"
          (click)="showCreateModal = false"
        ></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label class="form-label">Account</label>
            <select
              class="form-select"
              [(ngModel)]="newTrade.accountId"
              name="accountId"
            >
              @for (acc of accounts; track acc.id) {
              <option [value]="acc.id">{{ acc.name }}</option>
              }
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Instrument</label>
            <select
              class="form-select"
              [(ngModel)]="newTrade.instrumentId"
              name="instrumentId"
            >
              @for (inst of instruments; track inst.id) {
              <option [value]="inst.id">{{ inst.code }}</option>
              }
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Direction</label>
            <select
              class="form-select"
              [(ngModel)]="newTrade.direction"
              name="direction"
            >
              <option value="BUY">BUY</option>
              <option value="SELL">SELL</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input
              type="number"
              class="form-control"
              [(ngModel)]="newTrade.quantity"
              name="quantity"
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Price</label>
            <input
              type="number"
              step="0.01"
              class="form-control"
              [(ngModel)]="newTrade.price"
              name="price"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="showCreateModal = false"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="createTrade()">
          Create
        </button>
      </div>
    </div>
  </div>
</div>
} @if (editingTrade) {
<div
  class="modal fade show d-block"
  style="background: rgba(0, 0, 0, 0.5)"
  tabindex="-1"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Trade</h5>
        <button type="button" class="btn-close" (click)="cancelEdit()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label class="form-label">Account</label>
            <select
              class="form-select"
              [(ngModel)]="editingTrade.account.id"
              name="accountId"
            >
              @for (acc of accounts; track acc.id) {
              <option [value]="acc.id">{{ acc.name }}</option>
              }
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Instrument</label>
            <select
              class="form-select"
              [(ngModel)]="editingTrade.instrument.id"
              name="instrumentId"
            >
              @for (inst of instruments; track inst.id) {
              <option [value]="inst.id">{{ inst.code }}</option>
              }
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Direction</label>
            <select
              class="form-select"
              [(ngModel)]="editingTrade.direction"
              name="direction"
            >
              <option value="BUY">BUY</option>
              <option value="SELL">SELL</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Quantity</label>
            <input
              type="number"
              class="form-control"
              [(ngModel)]="editingTrade.quantity"
              name="quantity"
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Price</label>
            <input
              type="number"
              step="0.01"
              class="form-control"
              [(ngModel)]="editingTrade.price"
              name="price"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="saveEdit()">
          Save
        </button>
      </div>
    </div>
  </div>
</div>
}
